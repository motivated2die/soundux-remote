<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <!-- PWA Essential Meta Tags -->
    <meta name="theme-color" content="#52b18c">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    
    <!-- Manifest and Icons -->
    <link rel="manifest" href="/manifest.json">
    <link rel="apple-touch-icon" href="/assets/icon-192x192.png">
    <link rel="icon" type="image/png" sizes="192x192" href="/assets/icon-192x192.png">
    <link rel="icon" type="image/png" sizes="512x512" href="/assets/icon-512x512.png">

    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">

    <!-- Fallback Splash Screen for Apple Devices -->
    <link href="/assets/splash-2048x2732.png" sizes="2048x2732" rel="apple-touch-startup-image">
    
    <title>Soundux Remote</title>
    
    <!-- Fonts and Styles -->
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/styles.css">
    <link rel="icon" href="assets/favicon.ico" type="image/x-icon"> 
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet">
    
    <!-- NoSleep.js library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/nosleep/0.12.0/NoSleep.min.js"></script>
    
    <style>
        html, body {
            margin: 0;
            padding: 0;
            width: 100vw;
            height: 100vh;
            overflow: hidden;
            overscroll-behavior-y: contain;
        }

        body {
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
            touch-action: manipulation;
        }
        
        /* Wakelock indicator as eye icon */
        #wakelock-indicator {
            display: inline-flex;
            align-items: center;
            font-size: 14px;
            margin: 0 4px;
            color: #777;
            vertical-align: middle;
        }
        
        #wakelock-indicator.active {
            color: var(--v-primary-base);
        }
        
        #wakelock-indicator .material-symbols-outlined {
            font-size: 14px;
            font-variation-settings: 'FILL' 1;
        }
    </style>
</head>
<body>
    <!-- Screen wakelock indicator is now placed inside server-status -->
    
    <div class="container">
        <main class="sounds-grid" id="sounds-container">
            <!-- Sounds will be dynamically added here -->
        </main>
        
        <!-- Add progress bar here -->
        <div id="sound-progress-container">
            <div id="sound-progress-bar"></div>
        </div>
        
        <nav class="tabs" id="tabs-container">
            <!-- Tabs will be dynamically added here -->
        </nav>

        <header>
            <div class="app-title">
                <img src="assets/soundux-logo.svg" alt="Soundux Logo" class="logo">
                <div class="title-group">
                    <h1>Soundux ðŸŽ®</h1>
                    <div class="server-status">
                        <span id="status-indicator" class="status-dot"></span>
                        <span id="wakelock-indicator"><span class="material-symbols-outlined">visibility_off</span></span>
                        <span id="server-status">Connecting...</span>
                    </div>
                </div>
            </div>
            <div class="header-actions">
                <button id="stop-all" class="btn btn-danger">
                    <span class="material-symbols-outlined">stop_circle</span>
                    <span class="stop-text">STOP</span>
                </button>
            </div>
        </header>
    </div>

    <!-- Sound Settings Menu - Add this before the closing body tag in index.html -->
    <div id="sound-settings-overlay" class="hidden">
        <div id="settings-backdrop"></div>
        <div id="settings-card">
        <div class="handle-bar"></div>
        
        <div class="sound-info">
            <h2 id="settings-sound-name">Sound Name</h2>
            <p id="settings-tab-name">Tab Name</p>
        </div>
        
        <div class="action-buttons">
            <button id="favorite-button" class="icon-button" data-type="favorite">
            <span class="material-symbols-outlined">favorite</span>
            </button>
            <button id="preview-button" class="action-button" data-state="preview">
            <span class="material-symbols-outlined">volume_up</span>
            <span class="button-text">Preview</span>
            </button>
        </div>
        
        <div class="divider"></div>
        
        <div class="volume-control">
            <h3>Volume Adjustment</h3>
            <div class="slider-container">
            <span class="material-symbols-outlined">volume_down</span>
            <input type="range" id="volume-slider" min="-50" max="50" value="0">
            <span class="material-symbols-outlined">volume_up</span>
            </div>
            <div class="volume-info">
            <span>Adjusts both local and remote volume</span>
            <button id="reset-volume" class="reset-button hidden">Reset</button>
            </div>
        </div>
        </div>
    </div>

    <script>
        // Improved screen wake lock implementation
        (function() {
            // Variables
            const noSleep = new NoSleep();
            let wakelockEnabled = false;
            const wakelockIndicator = document.getElementById('wakelock-indicator');
            let wakelockAttempts = 0;
            const MAX_ATTEMPTS = 5;
            
            // Main function to enable wakelock
            function enableWakeLock() {
                if (wakelockEnabled) return; // Already enabled
                
                try {
                    // First try the modern Screen Wake Lock API
                    if ('wakeLock' in navigator) {
                        requestWakeLock();
                    } else {
                        // Fall back to NoSleep.js
                        enableNoSleep();
                    }
                } catch (err) {
                    console.error('Error enabling wake lock:', err);
                    fallbackToNoSleep();
                }
            }
            
            // Modern Screen Wake Lock API implementation
            async function requestWakeLock() {
                try {
                    const wakeLock = await navigator.wakeLock.request('screen');
                    wakelockEnabled = true;
                    updateWakeLockIndicator(true);
                    console.log('Wake Lock enabled with the Screen Wake Lock API');
                    
                    // Re-request wake lock when document becomes visible again
                    wakeLock.addEventListener('release', () => {
                        console.log('Wake Lock released');
                        wakelockEnabled = false;
                        updateWakeLockIndicator(false);
                        
                        // Try to re-acquire when released
                        if (document.visibilityState === 'visible') {
                            enableWakeLock();
                        }
                    });
                    
                } catch (err) {
                    console.warn('Screen Wake Lock API failed:', err.message);
                    fallbackToNoSleep();
                }
            }
            
            // NoSleep.js implementation
            function enableNoSleep() {
                noSleep.enable()
                    .then(() => {
                        wakelockEnabled = true;
                        updateWakeLockIndicator(true);
                        console.log('NoSleep enabled successfully');
                        
                        // Set up a periodic check to ensure it stays enabled
                        setUpPeriodicWakeLockCheck();
                    })
                    .catch(error => {
                        console.error('NoSleep error:', error);
                        
                        // If we haven't exceeded max attempts, try again on next user interaction
                        if (wakelockAttempts < MAX_ATTEMPTS) {
                            wakelockAttempts++;
                            console.log(`Attempt ${wakelockAttempts}/${MAX_ATTEMPTS} failed. Will retry on next user interaction.`);
                            setupWakeLockTriggers();
                        }
                    });
            }
            
            // Fallback method if primary method fails
            function fallbackToNoSleep() {
                console.log('Falling back to NoSleep.js');
                enableNoSleep();
            }
            
            // Set up periodic checking to make sure wakelock stays active
            function setUpPeriodicWakeLockCheck() {
                // Check every 15 seconds if the wakelock is still active
                setInterval(() => {
                    if (!wakelockEnabled || (noSleep && !noSleep.isEnabled)) {
                        console.log('Wake lock appears to be inactive, re-enabling...');
                        enableWakeLock();
                    }
                }, 15000);
            }
            
            // Update visual indicator
            function updateWakeLockIndicator(active) {
                if (wakelockIndicator) {
                    if (active) {
                        wakelockIndicator.classList.add('active');
                        wakelockIndicator.innerHTML = '<span class="material-symbols-outlined">visibility</span>';
                    } else {
                        wakelockIndicator.classList.remove('active');
                        wakelockIndicator.innerHTML = '<span class="material-symbols-outlined">visibility_off</span>';
                    }
                }
            }
            
            // Set up event listeners to enable wakelock on interaction
            function setupWakeLockTriggers() {
                const interactiveElements = [
                    document.body,
                    document.getElementById('stop-all'),
                    document.getElementById('sounds-container'),
                    document.getElementById('tabs-container')
                ];
                
                interactiveElements.forEach(el => {
                    if (el) {
                        el.addEventListener('click', handleUserInteraction);
                        el.addEventListener('touchstart', handleUserInteraction);
                    }
                });
            }
            
            // Handle user interaction
            function handleUserInteraction() {
                if (!wakelockEnabled) {
                    console.log('User interaction detected, enabling wake lock');
                    enableWakeLock();
                }
                
                // Also request fullscreen if not already fullscreen
                if (!document.fullscreenElement) {
                    requestFullscreen();
                }
            }
            
            // Fullscreen request function
            function requestFullscreen() {
                const elem = document.documentElement;
                if (elem.requestFullscreen) {
                    elem.requestFullscreen().catch(err => {
                        console.warn('Fullscreen request failed:', err);
                    });
                } else if (elem.mozRequestFullScreen) {
                    elem.mozRequestFullScreen();
                } else if (elem.webkitRequestFullscreen) {
                    elem.webkitRequestFullscreen();
                } else if (elem.msRequestFullscreen) {
                    elem.msRequestFullscreen();
                }
            }
            
            // Handle visibility change
            document.addEventListener('visibilitychange', () => {
                if (document.visibilityState === 'visible') {
                    console.log('Document became visible, re-enabling wake lock');
                    enableWakeLock();
                    
                    // When returning to the app, try to go fullscreen again
                    if (!document.fullscreenElement) {
                        requestFullscreen();
                    }
                }
            }, false);
            
            // Standalone mode detection
            function checkStandaloneMode() {
                const isStandalone = window.matchMedia('(display-mode: standalone)').matches || 
                                    window.navigator.standalone || 
                                    document.referrer.includes('android-app://');
                                    
                if (isStandalone) {
                    console.log('Running in standalone/PWA mode');
                    document.body.classList.add('standalone-mode');
                    
                    // In standalone mode, enable wakelock immediately
                    setTimeout(enableWakeLock, 1000);
                }
            }
            
            // Observer for dynamically added interactive elements
            function setupObserver() {
                const observer = new MutationObserver((mutations) => {
                    mutations.forEach((mutation) => {
                        if (mutation.addedNodes && mutation.addedNodes.length > 0) {
                            mutation.addedNodes.forEach((node) => {
                                if (node.nodeType === 1) { // Element node
                                    if (node.classList && 
                                       (node.classList.contains('sound-card') || 
                                        node.classList.contains('tab'))) {
                                        node.addEventListener('click', handleUserInteraction);
                                        node.addEventListener('touchstart', handleUserInteraction);
                                    }
                                }
                            });
                        }
                    });
                });

                observer.observe(document.body, {
                    childList: true,
                    subtree: true
                });
            }
            
            // Initialize everything
            document.addEventListener('DOMContentLoaded', () => {
                checkStandaloneMode();
                setupWakeLockTriggers();
                setupObserver();
                setUpPeriodicWakeLockCheck();
                
                // Try to enable on first load with a slight delay
                setTimeout(() => {
                    // Try to enable wake lock automatically
                    enableWakeLock();
                }, 2000);
            });
            
            // Expose the functions globally for debugging
            window.screenWakeLock = {
                enable: enableWakeLock,
                isEnabled: () => wakelockEnabled
            };
        })();
    </script>
    <script src="js/app.js"></script>
    <script src="js/tabs.js"></script>
    <script src="js/sound-settings.js"></script>
</body>
</html>